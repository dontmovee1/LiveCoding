name: UI Tests

on: workflow_dispatch

jobs:
  ui-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v3

      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0  # Важно для истории коммитов

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Run UI-tests via docker-compose
        env:
          LOGIN: ${{ secrets.LOGIN }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          docker compose up --exit-code-from regression || true

      - name: Prepare Allure results directory
        run: |
          mkdir -p allure-results/history
          # Копируем историю только если она существует
          if [ -d "gh-pages/history" ]; then
            cp -r gh-pages/history/* allure-results/history/
          fi

      - name: Generate Allure report
        run: |
          docker compose run regression /bin/sh -c "allure generate allure-results --clean -o allure-report"

      - name: Update Allure history
        run: |
          mkdir -p gh-pages/history
          cp -r allure-report/history/* gh-pages/history/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: ./  # Для размещения в корне gh-pages
          keep_files: false